"""
C ПанельМетеоролога
+обработчикНажатияКнопки():void
ПанельМетеоролога->ПрогнозView
ForecastServiceController->(вызывает команды)ПанельМетеоролога
"""

import logging
from typing import Dict, Any

from views.interfaces import ПрогнозView, ОсновнойИнтерфейс
from controllers.forecast_service_controller import ForecastServiceController


class ПанельМетеоролога:
    """
    Панель метеоролога
    C ПанельМетеоролога
    """

    def __init__(self, прогноз_view: ПрогнозView,
                 основной_интерфейс: ОсновнойИнтерфейс,
                 forecast_controller: ForecastServiceController):
        """
        Конструктор получает зависимости через DI
        ПанельМетеоролога->ПрогнозView
        ПанельМетеоролога->ОсновнойИнтерфейс
        """
        self.прогноз_view = прогноз_view
        self.основной_интерфейс = основной_интерфейс
        self.forecast_controller = forecast_controller
        self.logger = logging.getLogger(__name__)
        self.активные_прогнозы: Dict[str, Any] = {}

    def обработчикНажатияКнопки(self, тип_кнопки: str, данные: Dict[str, Any] = None) -> None:
        """+обработчикНажатияКнопки():void"""
        self.logger.info(f"Нажата кнопка: {тип_кнопки}")

        обработчики = {
            "запустить_прогноз": self._обработчикЗапускаПрогноза,
            "обновить_карту": self._обработчикОбновленияКарты,
            "показать_детали": self._обработчикПоказатьДетали,
            "верифицировать": self._обработчикВерификации,
            "создать_оповещение": self._обработчикСозданияОповещения
        }

        if тип_кнопки in обработчики:
            try:
                обработчики[тип_кнопки](данные)
            except Exception as e:
                self.основной_интерфейс.отобразитьОшибку(f"Ошибка: {e}")
                self.logger.error(f"Ошибка обработки кнопки {тип_кнопки}: {e}")
        else:
            self.основной_интерфейс.отобразитьОшибку(f"Неизвестная кнопка: {тип_кнопки}")

    async def _обработчикЗапускаПрогноза(self, данные: Dict[str, Any]) -> None:
        """Обработчик запуска прогноза"""
        регион = данные.get("регион", "Минск")
        тип_модели = данные.get("модель", "WRF-ARW")

        self.основной_интерфейс.обновитьСтатус(f"Запуск модели {тип_модели} для {регион}...")

        try:
            # ForecastServiceController->(вызывает команды)ПанельМетеоролога
            прогноз = await self.forecast_controller.запуститьМодель(тип_модели, регион)

            # Сохранение активного прогноза
            self.активные_прогнозы[прогноз.идПрогноза] = прогноз

            # Отображение результатов
            self.прогноз_view.обновитьПрогноз({
                "id": прогноз.идПрогноза,
                "регион": прогноз.регион,
                "температура": прогноз.температура,
                "осадки": прогноз.вероятностьОсадков
            })

            # Показать карту погоды
            self.прогноз_view.показатьКартуПогоды({
                "регион": регион,
                "температура": прогноз.температура,
                "ветер": прогноз.скоростьВетра,
                "осадки": прогноз.вероятностьОсадков
            })

            self.основной_интерфейс.отобразитьСообщение(
                f"Прогноз для {регион} создан успешно",
                "success"
            )

        except Exception as e:
            self.основной_интерфейс.отобразитьОшибку(f"Ошибка создания прогноза: {e}")

    async def _обработчикОбновленияКарты(self, данные: Dict[str, Any]) -> None:
        """Обработчик обновления карты"""
        регион = данные.get("регион", "Минск")

        self.основной_интерфейс.обновитьСтатус(f"Обновление карты для {регион}...")

        # Запрос последнего прогноза
        try:
            результат = await self.forecast_controller.получитьПоследнийПрогноз(регион)

            if результат["status"] == "success":
                прогноз = результат["forecast"]
                self.прогноз_view.показатьКартуПогоды(прогноз)
                self.основной_интерфейс.отобразитьСообщение("Карта обновлена", "info")
            else:
                self.основной_интерфейс.отобразитьСообщение(
                    "Нет данных для отображения",
                    "warning"
                )

        except Exception as e:
            self.основной_интерфейс.отобразитьОшибку(f"Ошибка обновления карты: {e}")

    async def _обработчикПоказатьДетали(self, данные: Dict[str, Any]) -> None:
        """Обработчик показа деталей прогноза"""
        прогноз_id = данные.get("прогноз_id")

        if прогноз_id in self.активные_прогнозы:
            прогноз = self.активные_прогнозы[прогноз_id]

            # Подготовка данных для графика
            график_данные = [
                {"время": f"+{i * 3}ч", "температура": прогноз.температура + i * 0.5}
                for i in range(8)
            ]

            self.прогноз_view.показатьГрафикПрогноза(график_данные)
            self.основной_интерфейс.отобразитьСообщение(
                f"Детали прогноза {прогноз_id} загружены",
                "info"
            )
        else:
            self.основной_интерфейс.отобразитьОшибку("Прогноз не найден")

    async def _обработчикВерификации(self, данные: Dict[str, Any]) -> None:
        """Обработчик верификации прогноза"""
        прогноз_id = данные.get("прогноз_id")

        if прогноз_id in self.активные_прогнозы:
            прогноз = self.активные_прогнозы[прогноз_id]

            self.основной_интерфейс.обновитьСтатус("Верификация прогноза...")

            try:
                результат = await self.forecast_controller.верифицироватьПрогноз(прогноз)

                if результат:
                    self.основной_интерфейс.отобразитьСообщение(
                        "Прогноз верифицирован успешно",
                        "success"
                    )
                else:
                    self.основной_интерфейс.отобразитьСообщение(
                        "Прогноз не прошел верификацию",
                        "warning"
                    )

            except Exception as e:
                self.основной_интерфейс.отобразитьОшибку(f"Ошибка верификации: {e}")
        else:
            self.основной_интерфейс.отобразитьОшибку("Прогноз не найден")

    async def _обработчикСозданияОповещения(self, данные: Dict[str, Any]) -> None:
        """Обработчик создания оповещения"""
        self.основной_интерфейс.обновитьСтатус("Создание оповещения...")

        # В реальной системе здесь был бы вызов контроллера оповещений
        self.основной_интерфейс.отобразитьСообщение(
            "Функция создания оповещений в разработке",
            "info"
        )

    def получитьАктивныеПрогнозы(self) -> Dict[str, Any]:
        """Получение списка активных прогнозов"""
        return {
            "количество": len(self.активные_прогнозы),
            "прогнозы": list(self.активные_прогнозы.keys())
        }

    def очиститьИсторию(self) -> None:
        """Очистка истории прогнозов"""
        self.активные_прогнозы.clear()
        self.основной_интерфейс.отобразитьСообщение("История очищена", "info")