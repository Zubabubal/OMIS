"""
C ПанельКлиматолога
ПанельКлиматолога->АализView
ReportController->(вызывает команды)ПанельКлиматолога
"""

import logging
from typing import Dict, Any, List

from views.interfaces import АнализView, ОсновнойИнтерфейс
from controllers.report_controller import ReportController


class ПанельКлиматолога:
    """
    Панель климатолога
    C ПанельКлиматолога
    """

    def __init__(self, анализ_view: АнализView,
                 основной_интерфейс: ОсновнойИнтерфейс,
                 report_controller: ReportController):
        """
        Конструктор получает зависимости через DI
        ПанельКлиматолога->АнализView
        ПанельКлиматолога->ОсновнойИнтерфейс
        """
        self.анализ_view = анализ_view
        self.основной_интерфейс = основной_интерфейс
        self.report_controller = report_controller
        self.logger = logging.getLogger(__name__)
        self.последние_отчеты: List[Dict[str, Any]] = []

    async def обработчикЗапросаДанных(self, параметры: Dict[str, Any]) -> None:
        """Обработчик запроса климатических данных"""
        период = параметры.get("период", "месяц")
        метрика = параметры.get("метрика", "температура")

        self.основной_интерфейс.обновитьСтатус(f"Запрос данных за {период}...")

        try:
            # ReportController->(вызывает команды)ПанельКлиматолога
            отчет = await self.report_controller.создатьКлиматическийОтчет(период)

            # Сохранение отчета
            self.последние_отчеты.append({
                "период": период,
                "данных": отчет.данных,
                "время": отчет.сгенерирован
            })

            # Отображение данных
            self.анализ_view.показатьКлиматическиеДанные({
                "период": период,
                "анализ": отчет.анализ,
                "рекомендации": отчет.рекомендации
            })

            # Построение графика трендов
            if метрика in отчет.анализ:
                данные_для_графика = [
                    {"период": f"День {i}", "значение": отчет.анализ[метрика].get("среднее", 0) + i}
                    for i in range(10)
                ]
                self.анализ_view.построитьГрафикТрендов(данные_для_графика)

            self.основной_интерфейс.отобразитьСообщение(
                f"Отчет за {период} создан: {отчет.данных} записей",
                "success"
            )

        except Exception as e:
            self.основной_интерфейс.отобразитьОшибку(f"Ошибка создания отчета: {e}")

    async def обработчикАнализаАномалий(self, параметры: Dict[str, Any]) -> None:
        """Обработчик анализа аномалий"""
        self.основной_интерфейс.обновитьСтатус("Анализ аномалий...")

        # Генерация тестовых данных аномалий
        аномалии = [
            {"дата": "2023-11-01", "тип": "температура", "отклонение": "+5.2°C", "уровень": "высокий"},
            {"дата": "2023-11-05", "тип": "осадки", "отклонение": "-30%", "уровень": "низкий"},
            {"дата": "2023-11-10", "тип": "ветер", "отклонение": "+8 м/с", "уровень": "высокий"}
        ]

        # Отображение таблицы аномалий
        self.анализ_view.отобразитьТаблицуАномалий()

        # Обновление статистики
        статистика = {
            "всего_аномалий": len(аномалии),
            "по_типам": {
                "температура": len([a for a in аномалии if a["тип"] == "температура"]),
                "осадки": len([a for a in аномалии if a["тип"] == "осадки"]),
                "ветер": len([a for a in аномалии if a["тип"] == "ветер"])
            },
            "период": "ноябрь 2023"
        }

        self.анализ_view.обновитьСтатистику(статистика)
        self.основной_интерфейс.отобразитьСообщение(
            f"Найдено {len(аномалии)} аномалий",
            "info"
        )

    async def обработчикЭкспортаДанных(self, параметры: Dict[str, Any]) -> None:
        """Обработчик экспорта данных"""
        формат = параметры.get("формат", "csv")
        период = параметры.get("период", "месяц")

        self.основной_интерфейс.обновитьСтатус(f"Экспорт данных в {формат}...")

        # В реальной системе здесь был бы экспорт данных
        self.основной_интерфейс.отобразитьСообщение(
            f"Данные за {период} экспортированы в {формат}",
            "success"
        )

    async def обработчикТрендовогоАнализа(self, параметры: Dict[str, Any]) -> None:
        """Обработчик трендового анализа"""
        метрика = параметры.get("метрика", "температура")
        годы = параметры.get("годы", 10)

        self.основной_интерфейс.обновитьСтатус(f"Трендовый анализ {метрика} за {годы} лет...")

        # Генерация тестовых данных трендов
        тренды = [
            {"год": 2014, "значение": 7.2},
            {"год": 2015, "значение": 7.5},
            {"год": 2016, "значение": 7.8},
            {"год": 2017, "значение": 8.1},
            {"год": 2018, "значение": 8.3},
            {"год": 2019, "значение": 8.6},
            {"год": 2020, "значение": 8.9},
            {"год": 2021, "значение": 9.2},
            {"год": 2022, "значение": 9.5},
            {"год": 2023, "значение": 9.8}
        ]

        # Построение графика трендов
        self.анализ_view.построитьГрафикТрендов(тренды)

        # Расчет статистики тренда
        if тренды:
            начальное = тренды[0]["значение"]
            конечное = тренды[-1]["значение"]
            изменение = конечное - начальное
            процент_изменения = (изменение / начальное) * 100

            self.основной_интерфейс.отобразитьСообщение(
                f"Тренд {метрика}: {изменение:+.1f} ({процент_изменения:+.1f}%) за {годы} лет",
                "info"
            )

    def получитьИсториюОтчетов(self) -> List[Dict[str, Any]]:
        """Получение истории отчетов"""
        return self.последние_отчеты

    def очиститьИсториюОтчетов(self) -> None:
        """Очистка истории отчетов"""
        self.последние_отчеты.clear()
        self.основной_интерфейс.отобразитьСообщение("История отчетов очищена", "info")